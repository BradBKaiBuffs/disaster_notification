{% extends "notification/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">

    <h2>Your Alert Subscriptions</h2>

    <a href="{% url 'forecasting' %}" class="btn btn-primary">
        CLICK HERE: View forecasting of disaster likelihood
    </a>

    {% if messages %}
        {% for msg in messages %}
            <div class="alert alert-info">{{ msg }}</div>
        {% endfor %}
    {% endif %}

    <!-- list of current subs -->
    <table class="table table-striped mt-3">
        <thead>
            <tr>
                <th>Area</th>
                <th>State</th>
                <th>County</th>
                <th>Phone</th>
                <th>Carrier</th>
                <th>Notification Type</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for sub in subscriptions %}
                <tr>
                    <td>{{ sub.area }}</td>
                    <td>{{ sub.state }}</td>
                    <td>{{ sub.county }}</td>
                    <td>{{ sub.phone_number }}</td>
                    <td>{{ sub.carrier_label }}</td>
                    <td>{{ sub.get_notification_type_display }}</td>
                    <td>
                        <a class="btn btn-sm btn-danger"
                           href="{% url 'delete_subscription' sub.id %}">
                            delete
                        </a>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="7">You have no subscriptions</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Active alerts from active subscriptions -->
    <hr class="my-4">

    <h3>Active Alerts in Your Subscribed Areas</h3>

    {% if active_alerts %}
    <div class="table-responsive mt-3">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Event</th>
                    <th>Area</th>
                    <th>Severity</th>
                    <th>Urgency</th>
                    <th>Sent</th>
                    <th>Expires</th>
                </tr>
            </thead>

            <tbody>
            {% for alert in active_alerts %}
                <tr class="
                    {% if alert.severity|lower == 'severe' %}table-danger
                    {% elif alert.severity|lower == 'moderate' %}table-warning
                    {% elif alert.severity|lower == 'minor' %}table-info
                    {% endif %}
                ">
                    <td>{{ alert.event }}</td>
                    <td>{{ alert.area_desc }}</td>
                    <td>{{ alert.severity }}</td>
                    <td>{{ alert.urgency }}</td>
                    <td>{{ alert.sent|date:'Y-m-d H:i' }}</td>
                    <td>{{ alert.expires|date:'Y-m-d H:i' }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-success mt-3">
        No active alerts currently
    </div>
    {% endif %}

    <!-- filter for the charts -->
    <form method="get" class="mb-3 w-50">
        <label class="form-label">Select State</label>
        <select name="state" id="graph-state" class="form-control">
            <option value="">Select State</option>
            {% for st in states %}
                <option value="{{ st }}" {% if st == selected_state %}selected{% endif %}>{{ st }}</option>
            {% endfor %}
        </select>

        <label class="form-label mt-2">Select County</label>
        <select name="county" id="graph-county" class="form-control">
            <option value="">Select County</option>
        </select>

        <button class="btn btn-secondary mt-3">Update</button>
    </form>

    {% if county_yearly_chart %}
        {{ county_yearly_chart|safe }}
    {% endif %}

    {% if county_event_type_chart %}
        {{ county_event_type_chart|safe }}
    {% endif %}

<script>
    // when a state is selected it matches the counties for it
    document.getElementById("graph-state").addEventListener("change", function () {

        let state = this.value;

        // asking backend for county list
        fetch(`/ajax/get-counties/?state=${state}`)
            .then(r => r.json())
            .then(data => {

                let countySelect = document.getElementById("graph-county");

                // reset dropdown
                countySelect.innerHTML = '<option value="">Select County</option>';

                // add county options
                data.counties.forEach(ct => {
                    let opt = document.createElement("option");
                    opt.value = ct;
                    opt.textContent = ct;
                    countySelect.appendChild(opt);
                });
            });
    });
</script>

{% endblock %}