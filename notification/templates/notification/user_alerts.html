{% extends "notification/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">

    <h2>Your Alert Subscriptions</h2>

    {% if messages %}
        {% for msg in messages %}
            <div class="alert alert-info">{{ msg }}</div>
        {% endfor %}
    {% endif %}

    <!-- list of current subs -->
    <table class="table table-striped mt-3">
        <thead>
            <tr>
                <th>Area</th>
                <th>State</th>
                <th>County</th>
                <th>Phone</th>
                <th>Carrier</th>
                <th>Notification Type</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for sub in subscriptions %}
                <tr>
                    <td>{{ sub.area }}</td>
                    <td>{{ sub.state }}</td>
                    <td>{{ sub.county }}</td>
                    <td>{{ sub.phone_number }}</td>
                    <td>{{ sub.carrier }}</td>
                    <td>{{ sub.get_notification_type_display }}</td>
                    <td>
                        <a class="btn btn-sm btn-danger"
                           href="{% url 'delete_subscription' sub.id %}">
                            delete
                        </a>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="7">no subscriptions found right now</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- filter for the charts -->
    <form method="get" class="mb-3 w-50">
        <label class="form-label">Select State</label>
        <select name="state" id="graph-state" class="form-control">
            <option value="">Select State</option>
            {% for st in states %}
                <option value="{{ st }}" {% if st == selected_state %}selected{% endif %}>{{ st }}</option>
            {% endfor %}
        </select>

        <label class="form-label mt-2">Select County</label>
        <select name="county" id="graph-county" class="form-control">
            <option value="">Select County</option>
        </select>

        <button class="btn btn-secondary mt-3">Update</button>
    </form>

    {% if county_yearly_chart %}
        {{ county_yearly_chart|safe }}
    {% endif %}

    {% if county_event_type_chart %}
        {{ county_event_type_chart|safe }}
    {% endif %}

    <!-- adds new subscription -->
    <h4 class="mt-4">Add New Subscription</h4>

    <form method="POST" action="{% url 'user_alerts' %}" class="card p-3 shadow-sm w-50">
        {% csrf_token %}

        <label class="form-label">Area</label>
        <input type="text"
               name="area"
               class="form-control"
               placeholder="Type City or Area"
               list="area-list">

        <!-- shows previous areas user typed -->
        <datalist id="area-list">
            {% for sub in subscriptions %}
                <option value="{{ sub.area }}"></option>
            {% endfor %}
        </datalist>

        <label class="form-label">State</label>
        <select id="state-select" name="state" class="form-control">
            <option value="">Select State</option>
            {% for st in states %}
                <option value="{{ st }}">{{ st }}</option>
            {% endfor %}
        </select>

        <label class="form-label mt-2">County</label>
        <select id="county-select" name="county" class="form-control">
            <option value="">Select County</option>
        </select>

        <label class="form-label mt-3">Phone Number</label>
        <input type="text"
               name="phone_number"
               class="form-control"
               placeholder="Enter phone number">

        <label class="form-label mt-3">Carrier</label>
        <select name="carrier" class="form-control">
            <option value="">Select Carrier</option>
            <option value="vtext.com">Verizon</option>
            <option value="txt.att.net">AT&amp;T</option>
            <option value="tmomail.net">T-Mobile</option>
            <option value="messaging.sprintpcs.com">Sprint</option>
            <option value="mms.uscc.net">US Cellular</option>
            <option value="message.alltel.com">AllTel</option>
        </select>

        <label class="form-label mt-3">Notification Type</label>
        {{ form.notification_type }}

        <button class="btn btn-primary mt-3">Add Subscription</button>
    </form>
</div>

<script>
    // when a state is selected it matches the counties for it
    document.getElementById("state-select").addEventListener("change", function () {

        let state = this.value;

        // asking backend for county list
        fetch(`/ajax/get-counties/?state=${state}`)
            .then(r => r.json())
            .then(data => {

                let countySelect = document.getElementById("county-select");

                // reset dropdown
                countySelect.innerHTML = '<option value="">Select County</option>';

                // add county options
                data.counties.forEach(ct => {
                    let opt = document.createElement("option");
                    opt.value = ct;
                    opt.textContent = ct;
                    countySelect.appendChild(opt);
                });
            });
    });
</script>

{% endblock %}