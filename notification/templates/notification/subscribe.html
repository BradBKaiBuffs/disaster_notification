{% extends "notification/base.html" %}
{% block content %}

<div class="container mt-4">
    <!-- TITLE -->
    <h2 class="mb-3">Subscribe to Notifications</h2>

    {% if not user.is_authenticated %}

        <div class="alert alert-info">
            Create an account and set alerts here
        </div>

        <form method="POST" class="card p-4 shadow">
            {% csrf_token %}

            <h5 class="mb-2">Account Info</h5>
            {{ user_form.as_p }}

            <hr>

            <h5 class="mt-3">Alert Settings</h5>

            <!-- AREA -->
            <label class="form-label">Area</label>
            {{ sub_form.area }}

            <!-- STATE -->
            <label class="form-label mt-2">State</label>
            <select id="state-select" name="state" class="form-control">
                <option value="">Select State</option>
                {% for st in states %}
                    <option value="{{ st }}">{{ st }}</option>
                {% endfor %}
            </select>

            <!-- COUNTY -->
            <label class="form-label mt-2">County</label>
            <select id="county-select" name="county" class="form-control">
                <option value="">Select County</option>
            </select>

            <!-- PHONE NUMBER -->
            <label class="form-label mt-3">Phone Number</label>
            {{ sub_form.phone_number }}

            <!-- NOTIFICATION TYPE -->
            <label class="form-label mt-3">Notification Type</label>
            {{ sub_form.notification_type }}

            <button class="btn btn-success mt-3">Register and Save Alerts</button>
        </form>

    {% else %}

        <div class="alert alert-success">
            Logged in as <strong>{{ user.username }}</strong>
        </div>

        <form method="POST" class="card p-4 shadow">
            {% csrf_token %}

            <!-- AREA -->
            <label class="form-label">Area</label>
            {{ sub_form.area }}

            <!-- STATE -->
            <label class="form-label mt-2">State</label>
            <select id="state-select" name="state" class="form-control">
                <option value="">Select State</option>
                {% for st in states %}
                    <option value="{{ st }}">{{ st }}</option>
                {% endfor %}
            </select>

            <!-- COUNTY -->
            <label class="form-label mt-2">County</label>
            <select id="county-select" name="county" class="form-control">
                <option value="">Select County</option>
            </select>

            <!-- PHONE NUMBER -->
            <label class="form-label mt-3">Phone Number</label>
            {{ sub_form.phone_number }}

            <!-- NOTIFICATION TYPE -->
            <label class="form-label mt-3">Notification Type</label>
            {{ sub_form.notification_type }}

            <button class="btn btn-primary mt-3">Save Subscription</button>
        </form>

    {% endif %}
</div>

<script>

    // listens for when user picks a state from the dropdown
    document.getElementById("state-select").addEventListener("change", function () {

        // gets selected state and sends it to backend
        let state = this.value;

        // fetches county list for that state
        fetch(`/ajax/get-counties/?state=${state}`)

            // json() turns response into js object
            .then(response => response.json())

            // update county dropdown options
            .then(data => {
                let countySelect = document.getElementById("county-select");

                // clear old options and reset placeholder
                countySelect.innerHTML = '<option value="">Select County</option>';

                // build new <option> tags for each county
                data.counties.forEach(ct => {
                    let opt = document.createElement("option");
                    opt.value = ct;
                    opt.textContent = ct;
                    countySelect.appendChild(opt);
                });
            });

    });
</script>

{% endblock %}