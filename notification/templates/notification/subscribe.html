{% extends "notification/base.html" %}
{% block content %}

<div class="container mt-4">

    <h2 class="mb-3">Subscribe to Notification</h2>
    
    <!-- sub success message -->
    {% if messages %}
        {% for msg in messages %}
            <div class="alert alert-{{ msg.tags }}">
                {{ msg }}
            </div>
        {% endfor %}
    {% endif %}

    {% if not user.is_authenticated %}

        <div class="alert alert-info">
            Create an account and pick what alerts you want.
        </div>

        <!-- user registration + subscription in one form -->
        <form method="POST" class="card p-4 shadow">
            {% csrf_token %}

            <h5 class="mb-2">Account Info</h5>
            {{ user_form.as_p }}

            <hr>

            <h5 class="mt-3">Alert Settings</h5>

            <!-- AREA NO LONGER USED (kept for reference only)
            <label class="form-label">Area</label>
            <input
                type="text"
                name="area"
                id="area-input"
                class="form-control"
                list="area-suggestions"
                value="{{ sub_form.initial.area }}"
            >
            -->

            <!-- 
            <datalist id="area-suggestions">
                {% for a in areas %}
                    <option value="{{ a }}"></option>
                {% endfor %}
            </datalist>
            -->

            <!-- state dropdown -->
            <label class="form-label mt-2">State</label>
            <select id="state-select" name="state" class="form-control state-select">
                <option value="">Select State</option>
                {% for st in states %}
                    <option value="{{ st }}">{{ st }}</option>
                {% endfor %}
            </select>

            <!-- county dropdown (populated after picking a state) -->
            <label class="form-label mt-2">County</label>
            <select name="county" class="form-control county-select">
                <option value="">Select County</option>
            </select>

            <!-- phone number -->
            <label class="form-label mt-3">Phone Number</label>
            {{ sub_form.phone_number }}

            <!-- opt-in requirement (Vonage) -->
            <p>
                By entering your phone number, you agree to receive alert-related messages
                from Disaster Notification page at the phone number provided.
                No marketing messages will be sent.
            </p>

            <!-- carrier removed but kept for legacy reference
            <label class="form-label mt-3">Carrier</label>
            <select name="carrier" class="form-control">
                <option value="">Select Carrier</option>
                <option value="vtext.com">Verizon</option>
                <option value="txt.att.net">AT&T</option>
                <option value="tmomail.net">T-Mobile</option>
                <option value="messaging.sprintpcs.com">Sprint</option>
                <option value="mms.uscc.net">US Cellular</option>
                <option value="message.alltel.com">AllTel</option>
            </select>
            -->

            <!-- notification type -->
            <label class="form-label mt-3">Notification Type</label>
            {{ sub_form.notification_type }}

            <button class="btn btn-success mt-3">Register and Save Alerts</button>
        </form>

    {% else %}

        <!-- logged-in user indicator -->
        <div class="alert alert-success">
            Logged in as <strong>{{ user.username }}</strong>
        </div>

        <!-- subscription form for logged-in users -->
        <form method="POST" class="card p-4 shadow">
            {% csrf_token %}

            <!-- AREA NO LONGER USED (kept for reference)
            <label class="form-label">Area</label>
            <input
                type="text"
                name="area"
                id="area-input"
                class="form-control"
                list="area-suggestions"
                value="{{ sub_form.instance.area }}"
            >
            -->

            <!-- 
            <datalist id="area-suggestions">
                {% for a in areas %}
                    <option value="{{ a }}"></option>
                {% endfor %}
            </datalist>
            -->

            <!-- state dropdown -->
            <label class="form-label mt-2">State</label>
            <select name="state" class="form-control state-select">
                <option value="">Select State</option>
                {% for st in states %}
                    <option value="{{ st }}">{{ st }}</option>
                {% endfor %}
            </select>

            <!-- county dropdown -->
            <label class="form-label mt-2">County</label>
            <select name="county" class="form-control county-select">
                <option value="">Select County</option>
            </select>

            <!-- phone number -->
            <label class="form-label mt-3">Phone Number</label>
            {{ sub_form.phone_number }}

            <!-- opt-in requirement -->
            <p>
                By entering your phone number, you agree to receive alert-related messages.
                No marketing messages will be sent because this is a school project.
            </p>

            <!-- carrier removed (legacy)
            <label class="form-label mt-3">Carrier</label>
            <select name="carrier" class="form-control">
                <option value="">Select Carrier</option>
                <option value="vtext.com">Verizon</option>
                <option value="txt.att.net">AT&T</option>
                <option value="tmomail.net">T-Mobile</option>
                <option value="messaging.sprintpcs.com">Sprint</option>
                <option value="mms.uscc.net">US Cellular</option>
                <option value="message.alltel.com">AllTel</option>
            </select>
            -->

            <!-- notification type -->
            <label class="form-label mt-3">Notification Type</label>
            {{ sub_form.notification_type }}

            <button class="btn btn-primary mt-3">Save Subscription</button>
        </form>

    {% endif %}
</div>

<script>
    // when a state is selected, load the matching counties from the backend
    document.addEventListener("DOMContentLoaded", function () {

        document.querySelectorAll(".state-select").forEach(function (stateSelect) {

            stateSelect.addEventListener("change", function () {

                // grab selected state
                const state = this.value;

                // find the county dropdown
                const form = this.closest("form");
                const countySelect = form.querySelector(".county-select");

                // reset dropdown
                countySelect.innerHTML = '<option value="">Select County</option>';

                // if nothing selected, do nothing
                if (!state) {
                    return;
                }

                // fetch counties
                fetch(`/ajax/get-counties/?state=${encodeURIComponent(state)}`)
                    .then(response => response.json())
                    .then(data => {

                        data.counties.forEach(ct => {
                            const opt = document.createElement("option");
                            opt.value = ct;
                            opt.textContent = ct;
                            countySelect.appendChild(opt);
                        });
                    })
                    .catch(error => {
                        console.error("Error loading counties:", error);
                    });
            });
        });
    });
</script>

{% endblock %}